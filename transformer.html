<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Transformer å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶äº’åŠ¨æ•™å­¦</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; line-height: 1.8; }
    h1 { color: #2c3e50; }
    .question { margin: 20px 0; }
    select, input[type="text"] { padding: 5px; margin-left: 10px; }
    .answer { display: none; margin-top: 10px; color: green; }
    button { margin-top: 10px; padding: 5px 10px; }
    code { background-color: #f4f4f4; padding: 2px 6px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>ğŸ§  Transformer å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶å®ç°æ•™å­¦</h1>
  <p>æœ¬èŠ‚è¯¾å°†å¸¦ä½ å®Œæˆ Transformer ä¸­çš„ <strong>Multi-Head Attention</strong> æ ¸å¿ƒå®ç°ï¼Œç†è§£å…¶å·¥ä½œåŸç†å¹¶è¡¥å…¨ä»£ç ã€‚</p>

  <h2>ğŸ“˜ é¢˜å¹²è¯´æ˜</h2>
  <p>
    å°çˆ±åŒå­¦æƒ³è¦è®¾è®¡ä¸€ä¸ªç¥ç»ç½‘ç»œæ¨¡å‹å®ç°è¯­éŸ³æƒ…æ„Ÿè¯†åˆ«ï¼Œä¸»è¦åˆ†ä¸ºç§¯ææƒ…æ„Ÿã€æ¶ˆææƒ…æ„Ÿå’Œä¸­æ€§æƒ…æ„Ÿã€‚
    å¥¹é¦–å…ˆé¢„å¤„ç†éŸ³é¢‘ï¼Œä½¿ç”¨é¢„è®­ç»ƒçš„ VGGish æå–éŸ³é¢‘ç‰¹å¾ï¼Œæ¯ä¸€ä¸ªéŸ³é¢‘å¾—åˆ°å¤§å°ä¸º <code>8x128</code> çš„ç‰¹å¾ï¼Œ
    å…¶ä¸­ 8 è¡¨ç¤ºè¯¥éŸ³é¢‘åœ¨æ—¶é—´ç»´åº¦ä¸Š 8 ä¸ªä¸é‡å çš„ç‰‡æ®µï¼Œ128 è¡¨ç¤ºæ¯ä¸ªç‰‡æ®µçš„ç‰¹å¾ç»´åº¦ã€‚
  </p>
  <p>
    ç„¶åå¥¹æƒ³è¦ä½¿ç”¨ 1D å·ç§¯å®ç°ç¥ç»ç½‘ç»œï¼Œè¯¥æ¨¡å‹åŒ…æ‹¬ä¸‰ä¸ªå·ç§¯å±‚ï¼Œä¸‰ä¸ªæ± åŒ–å±‚å’Œä¸¤ä¸ªå…¨è¿æ¥å±‚ã€‚
    <ul>
      <li>ç¬¬ä¸€ä¸ªå·ç§¯å±‚åŒ…æ‹¬ 64 ä¸ªå¤§å°ä¸º 3 çš„1D å·ç§¯æ ¸ï¼Œpadding å’Œ stride éƒ½ä¸º 1ï¼›</li>
      <li>ç¬¬äºŒä¸ªå·ç§¯å±‚åŒ…æ‹¬ 32 ä¸ªå¤§å°ä¸º 3 çš„å·ç§¯æ ¸ï¼Œpadding å’Œ stride ä¸º 1ï¼›</li>
      <li>ç¬¬ä¸‰ä¸ªå·ç§¯å±‚åŒ…æ‹¬ 16 ä¸ªå¤§å°ä¸º 3 çš„å·ç§¯æ ¸ï¼Œpadding å’Œ stride ä¸º 1ï¼›</li>
      <li>æ¯ä¸ªå·ç§¯å±‚åéƒ½æœ‰ä¸€ä¸ªæœ€å¤§æ± åŒ–å±‚ï¼Œæ± åŒ–å±‚çš„æ ¸å¤§å°ä¸º 2ï¼Œstride ä¸º 2ï¼Œpadding ä¸º 0ï¼›</li>
      <li>å·ç§¯å±‚ä¸­ä½¿ç”¨ ReLU å‡½æ•°ä½œä¸ºæ¿€æ´»å‡½æ•°ã€‚</li>
      <li>ç¬¬ä¸€ä¸ªå…¨è¿æ¥å±‚çš„è¾“å…¥èŠ‚ç‚¹ä¸º 16ï¼Œè¾“å‡ºèŠ‚ç‚¹ä¸º 8ã€‚</li>
    </ul>
  </p>
  <p>
    ä½†æ˜¯ä½œä¸ºåˆå­¦è€…çš„å¥¹å¹¶ä¸ç†Ÿæ‚‰ PyTorchï¼Œæ‰€ä»¥å¸Œæœ›ä½ å¯ä»¥å¸®åŠ©å¥¹å®Œæˆç¥ç»ç½‘ç»œçš„æ­å»ºä»¥åŠè®­ç»ƒè¿‡ç¨‹ä»£ç ï¼š
  </p>
  <pre><code>class Model(nn.Module):
    def __init__(self) -> None:
        super().__init__()
        self.conv1 = nn.Sequential(
            nn.Conv1d(in_channels=128, out_channels=64, kernel_size=3, stride=1, padding=1),
            nn.ReLU(), ___________(1)____________
        )
        self.conv2 = nn.Sequential(
            ___________(2)____________, nn.ReLU(), nn.MaxPool1d(kernel_size=2, stride=2)
        )
        self.conv3 = nn.Sequential(
            nn.Conv1d(in_channels=32, out_channels=16, kernel_size=3, stride=1, padding=1),
            ___________(3)____________, nn.MaxPool1d(kernel_size=2, stride=2)
        )
        self.fc = nn.Sequential(
            nn.Linear(in_features=__(4)__, out_features=_(5)__),
            nn.Linear(in_features=_(6)__, out_features=__(7)__)
        )

    def forward(self, x):
        x = x.transpose(1, 2)
        x = self.conv1(x)
        x = self.conv2(x)
        x = self.conv3(x)
        x = x.transpose(1, 2).squeeze(1)
        x = self.fc(x)
        return x

model = Model()  # å®ä¾‹åŒ–æ¨¡å‹
loss_fn = nn.CrossEntropyLoss()  # äº¤å‰ç†µæŸå¤±å‡½æ•°
x = torch.randn([4, 8, 128])  # è¾“å…¥éŸ³é¢‘ç‰¹å¾, batch_size=4
label = torch.tensor([0, 2, 0, 1])  # éŸ³é¢‘æƒ…æ„Ÿæ ‡ç­¾
y = model(x)  # æ¨¡å‹é¢„æµ‹ç»“æœ
loss = loss_fn(___(8)__, ___(9)___)  # è®¡ç®—æŸå¤±
</code></pre>

  <h2>âœï¸ å¡«ç©ºç»ƒä¹ </h2>

  <!-- Question 1 -->
  <div class="question">
    <strong>(1) æ³¨æ„åŠ›å¾—åˆ†çš„è®¡ç®—ï¼š</strong><br>
    <code>scores = ?</code><br>
    <input type="text" id="input1" placeholder="è¯·è¾“å…¥ä»£ç ç‰‡æ®µ">
    <button onclick="checkAnswer(1, 'np.matmul(Q, K.transpose(0, 2, 1)) / np.sqrt(d_k)')">æ£€æŸ¥</button>
    <div class="answer" id="answer1"></div>
  </div>

  <!-- Question 2 -->
  <div class="question">
    <strong>(2) è¾“å‡ºæƒé‡çŸ©é˜µ <code>WO</code> çš„åˆå§‹åŒ–å½¢çŠ¶ï¼Ÿ</strong><br>
    <input type="text" id="input2" placeholder="å½¢å¦‚ (a, b)">
    <button onclick="checkAnswer(2, 'self.num_heads * self.head_dim, input_dim')">æ£€æŸ¥</button>
    <div class="answer" id="answer2"></div>
  </div>

  <!-- Question 3 -->
  <div class="question">
    <strong>(3) æ¯ä¸ªå¤´çš„ Query Q è®¡ç®—ä»£ç ï¼Ÿ</strong><br>
    <input type="text" id="input3" placeholder="å¦‚ np.matmul(X, ...)" size="50">
    <button onclick="checkAnswer(3, 'np.matmul(X, self.WQ[i])')">æ£€æŸ¥</button>
    <div class="answer" id="answer3"></div>
  </div>

  <!-- Question 4 -->
  <div class="question">
    <strong>(4) æ¯ä¸ªå¤´çš„ Key K è®¡ç®—ä»£ç ï¼Ÿ</strong><br>
    <input type="text" id="input4" placeholder="å¦‚ np.matmul(X, ...)" size="50">
    <button onclick="checkAnswer(4, 'np.matmul(X, self.WK[i])')">æ£€æŸ¥</button>
    <div class="answer" id="answer4"></div>
  </div>

  <!-- Question 5 -->
  <div class="question">
    <strong>(5) æ¯ä¸ªå¤´çš„ Value V è®¡ç®—ä»£ç ï¼Ÿ</strong><br>
    <input type="text" id="input5" placeholder="å¦‚ np.matmul(X, ...)" size="50">
    <button onclick="checkAnswer(5, 'np.matmul(X, self.WV[i])')">æ£€æŸ¥</button>
    <div class="answer" id="answer5"></div>
  </div>

  <script>
    function checkAnswer(id, expected) {
      const input = document.getElementById('input' + id).value.trim().replace(/\s+/g, '');
      const expectedNormalized = expected.replace(/\s+/g, '');
      const result = document.getElementById('answer' + id);
      if (input === expectedNormalized) {
        result.innerHTML = 'âœ… æ­£ç¡®ï¼';
        result.style.color = 'green';
      } else {
        result.innerHTML = 'âŒ é”™è¯¯ï¼Œå‚è€ƒç­”æ¡ˆï¼š<code>' + expected + '</code>';
        result.style.color = 'red';
      }
      result.style.display = 'block';
    }
  </script>
</body>
</html>
